<!-- Views/CalendarWidget.xaml -->
<UserControl x:Class="PersonalDashboard.Views.CalendarWidget"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             Background="Transparent">
    <UserControl.Resources>

        <!-- ===== Modern, dark Calendar look ===== -->
        <!-- Make the whole Calendar transparent/dark-text -->
        <Style TargetType="{x:Type Calendar}">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderBrush" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Foreground" Value="{StaticResource TextPrimary}"/>
            <Setter Property="Margin" Value="0"/>
        </Style>

        <!-- Restyle day buttons (hover/selected/today) with rounded pill look -->
        <Style TargetType="{x:Type CalendarDayButton}">
            <Setter Property="Foreground" Value="{StaticResource TextPrimary}"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderBrush" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Padding" Value="4"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type CalendarDayButton}">
                        <Border x:Name="Bd"
                    Background="{TemplateBinding Background}"
                    CornerRadius="8"
                    BorderBrush="{TemplateBinding BorderBrush}"
                    BorderThickness="{TemplateBinding BorderThickness}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <!-- Dim out days from previous/next month -->
                            <Trigger Property="IsInactive" Value="True">
                                <Setter Property="Foreground" Value="{StaticResource TextMuted}"/>
                            </Trigger>
                            <!-- Hover -->
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="#22FFFFFF"/>
                            </Trigger>
                            <!-- Selected day -->
                            <Trigger Property="IsSelected" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="#33FFFFFF"/>
                                <Setter TargetName="Bd" Property="BorderBrush" Value="#66FFFFFF"/>
                                <Setter TargetName="Bd" Property="BorderThickness" Value="1"/>
                            </Trigger>
                            <!-- Today's outline -->
                            <Trigger Property="IsToday" Value="True">
                                <Setter TargetName="Bd" Property="BorderBrush" Value="{StaticResource Accent}"/>
                                <Setter TargetName="Bd" Property="BorderThickness" Value="2"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- ===== Simple expand/collapse animations for the Events panel ===== -->
        <Storyboard x:Key="ExpandEvents">
            <!-- Animate height via MaxHeight (works nicely with Auto layout) -->
            <DoubleAnimation Storyboard.TargetName="EventsPanel"
                       Storyboard.TargetProperty="MaxHeight"
                       To="160" Duration="0:0:0.25"/>
            <DoubleAnimation Storyboard.TargetName="EventsPanel"
                       Storyboard.TargetProperty="Opacity"
                       To="1" Duration="0:0:0.25"/>
        </Storyboard>

        <Storyboard x:Key="CollapseEvents">
            <DoubleAnimation Storyboard.TargetName="EventsPanel"
                       Storyboard.TargetProperty="MaxHeight"
                       To="0" Duration="0:0:0.20"/>
            <DoubleAnimation Storyboard.TargetName="EventsPanel"
                       Storyboard.TargetProperty="Opacity"
                       To="0" Duration="0:0:0.20"/>
        </Storyboard>

    </UserControl.Resources>

    <!-- ===== Layout ===== -->
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <!-- calendar -->
            <RowDefinition Height="8"/>
            <!-- spacer -->
            <RowDefinition Height="Auto"/>
            <!-- toggle -->
            <RowDefinition Height="Auto"/>
            <!-- events panel -->
        </Grid.RowDefinitions>

        <!-- Calendar itself (uses styles above) -->
        <Calendar Grid.Row="0"
              SelectedDate="{Binding SelectedDate, Mode=TwoWay}"
              IsTodayHighlighted="True" />

        <!-- Toggle row: "Events" with a chevron that rotates -->
        <!-- Toggle row: "Events" with a chevron that rotates -->
        <ToggleButton x:Name="EventsToggle"
              Grid.Row="2"
              IsChecked="{Binding IsEventsOpen, Mode=TwoWay}"
              HorizontalAlignment="Left"
              Padding="8,4"
              Foreground="{StaticResource TextPrimary}"
              Background="{StaticResource FieldBg}"
              BorderBrush="{StaticResource FieldBorder}"
              BorderThickness="1"
              Cursor="Hand">
            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                <TextBlock Text="Events" Margin="0,0,6,0"/>
                <!-- chevron -->
                <Path Data="M 0 0 L 4 4 L 8 0"
          Stroke="{StaticResource TextPrimary}" StrokeThickness="2"
          Stretch="Uniform" Width="10" Height="8">
                    <Path.RenderTransform>
                        <!-- This rotates when bound to IsChecked -->
                        <RotateTransform Angle="{Binding IsChecked, ElementName=EventsToggle,
                                         Converter={StaticResource BoolToAngleConverter}}"/>
                    </Path.RenderTransform>
                </Path>
            </StackPanel>

            <!-- Animation triggers for events panel -->
            <ToggleButton.Triggers>
                <EventTrigger RoutedEvent="ToggleButton.Checked">
                    <BeginStoryboard Storyboard="{StaticResource ExpandEvents}"/>
                </EventTrigger>
                <EventTrigger RoutedEvent="ToggleButton.Unchecked">
                    <BeginStoryboard Storyboard="{StaticResource CollapseEvents}"/>
                </EventTrigger>
            </ToggleButton.Triggers>
        </ToggleButton>


        <!-- Events panel: starts collapsed (MaxHeight=0, Opacity=0) -->
        <Border x:Name="EventsPanel" Grid.Row="3"
            MaxHeight="0" Opacity="0"
            Margin="0,6,0,0"
            Padding="8"
            CornerRadius="8"
            Background="#141414"
            BorderBrush="#22FFFFFF" BorderThickness="1">
            <!-- Your events for the selected day -->
            <ItemsControl ItemsSource="{Binding EventsForSelectedDate}">
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <StackPanel Orientation="Horizontal" Margin="0,2">
                            <Ellipse Width="6" Height="6" Fill="{StaticResource TextMuted}" Margin="0,0,6,0"/>
                            <TextBlock Text="{Binding Title}" />
                        </StackPanel>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>

                <!-- Empty state -->
                <ItemsControl.Style>
                    <Style TargetType="ItemsControl">
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding EventsForSelectedDate.Count}" Value="0">
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="ItemsControl">
                                            <TextBlock Text="Nothing today 🎉" Foreground="{StaticResource TextMuted}"/>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </ItemsControl.Style>
            </ItemsControl>
        </Border>
    </Grid>
</UserControl>
